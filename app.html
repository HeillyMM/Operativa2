<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - Regresión Multivariada</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
    
    /* Animaciones suaves */
    .fade-in { animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn { 
        from { opacity: 0; transform: translateY(10px); } 
        to { opacity: 1; transform: translateY(0); } 
    }
    
    /* ⭐ Sidebar más ordenado */
    .sidebar-link { 
        margin-bottom: 6px; /* separación extra entre botones */
    }

    /* ⭐ Separación vertical entre normalidad–autocorrelación–homocedasticidad */
    .stat-card {
        padding: 10px;            /* NO MODIFICADO */
        margin-top: 6px !important;
    }

    /* ⭐ Subir un poco los títulos de los gráficos */
    .chart-title {
        position: absolute;
        top: -20px;
        left: -50px;
        font-weight: bold;
        font-size: 0.9rem;
        color: #475569;
        margin-left: 100px;
    }
    .page-break-print {
        page-break-before: always !important;
        break-before: always !important;
    }
    /* ======================================
       ⭐ ESTILOS PARA IMPRESIÓN (NEW)
       Para que se impriman TODOS los gráficos,
       TODAS las tablas y todo sin cortes.
       ====================================== */
    @media print {

        /* Fondo blanco y todo visible */
        body, html {
            height: auto !important;
            overflow: visible !important;
            background: white !important;
        }

        /* Mostrar todo el contenido, sin recortes */
        .overflow-hidden,
        .overflow-x-auto,
        .overflow-y-auto {
            overflow: visible !important;
        }

        /* Ocultar elementos no deseados */
        aside,
        header,
        button,
        .no-print {
            display: none !important;
        }

        /* Expandir el contenido al ancho completo */
        main {
            width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* Asegurar que los gráficos de Chart.js sí se impriman */
        canvas {
            max-width: 100% !important;
            max-height: 100% !important;
            page-break-inside: avoid !important;
        }

        /* Evitar cortes en tarjetas y gráficos */
        .stat-card,
        .chart-container,
        .report-section {
            break-inside: avoid !important;
            page-break-inside: avoid !important;
        }

        /* Poner todo en formato vertical (sin flex) */
        .flex {
            display: block !important;
        }
        /* Forzar que Diagnóstico Visual empiece en otra página */
        .page-break-print {
            page-break-before: always !important;
            break-before: always !important;
            display: block !important;
        }

        
    }
    
</style>

</head>

<body class="bg-slate-50 text-slate-800 flex h-screen overflow-hidden">

    <!-- SIDEBAR -->
    <aside class="w-64 bg-slate-900 text-white flex-shrink-0 hidden md:flex flex-col shadow-2xl z-20">
        <div class="p-6 border-b border-slate-800 flex items-center">
            
            <h1 class="font-bold text-xl tracking-wider">Regresión Multi</h1>
        </div>
        
        <nav class="flex-1 mt-6 overflow-y-auto">

            <a onclick="switchTab('upload')" id="nav-upload" 
            class="sidebar-link active flex items-center px-6 py-4 border-b border-slate-800">
                
                <span>Datos</span>
            </a>

            <a onclick="switchTab('config')" id="nav-config" 
            class="sidebar-link flex items-center px-6 py-4 opacity-50 pointer-events-none border-b border-slate-800">
                
                <span>Variables</span>
            </a>

            <a onclick="switchTab('stats')" id="nav-stats" 
            class="sidebar-link flex items-center px-6 py-4 opacity-50 pointer-events-none border-b border-slate-800">
              
                <span>Descriptivos</span>
            </a>

            <a onclick="switchTab('results')" id="nav-results" 
            class="sidebar-link flex items-center px-6 py-4 opacity-50 pointer-events-none border-b border-slate-800">
                
                <span>Modelo & Gráficos</span>
            </a>

        </nav>
        <div class="p-4 border-t border-slate-800 text-xs text-slate-500 text-center">
            Versión 2.0 Pro
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
        
        <header class="bg-white shadow-sm h-16 flex items-center justify-between px-6 z-10">
            <div class="text-sm breadcrumbs text-slate-500">
                <span id="step-indicator" class="font-semibold text-indigo-600">Paso 1: Carga de Datos</span>
            </div>
            <div class="flex items-center space-x-4">
                <button class="md:hidden text-slate-600"><i class="fas fa-bars text-xl"></i></button>
            </div>
        </header>

        <!-- Área principal -->
        <div class="flex-1 overflow-y-auto p-6 md:p-10 relative">

            <!-- UPLOAD -->
            <section id="view-upload" class="max-w-4xl mx-auto fade-in">
                <div class="text-center mb-10">
                    <h2 class="text-3xl font-bold text-slate-800">Comencemos el Análisis</h2>
                    <p class="text-slate-500 mt-2">Sube tu archivo CSV para iniciar el procesamiento.</p>
                </div>

                <div class="bg-white rounded-2xl shadow-lg border-2 border-dashed border-indigo-100 p-12 text-center hover:border-indigo-300 transition-colors group cursor-pointer relative">
                    <input type="file" id="csvInput" accept=".csv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                    <div class="group-hover:scale-105 transition-transform duration-300">
                        <div class="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-4 text-indigo-600">
                            <i class="fas fa-file-csv text-3xl"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-slate-700">Arrastra tu CSV aquí</h3>
                        <p class="text-sm text-slate-400 mt-2">o haz clic para explorar archivos</p>
                    </div>
                </div>

                <div id="previewContainer" class="mt-8 hidden bg-white rounded-xl shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-700">Vista Previa de Datos</h3>
                        <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">Archivo Cargado</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table id="previewTable" class="w-full text-sm text-left text-slate-600"></table>
                    </div>
                    <div class="mt-6 text-right">
                        <button onclick="goToConfig()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition">
                            Siguiente: Configurar Variables <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
            </section>

            <!-- CONFIG -->
            <section id="view-config" class="hidden max-w-5xl mx-auto fade-in">
                <h2 class="text-2xl font-bold text-slate-800 mb-6">Configuración</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Variable Dependiente (Y)</label>
                        <select id="selectY" class="w-full bg-slate-50 border border-slate-200 text-slate-700 py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></select>
                        <p class="text-xs text-slate-400 mt-3">Esta es la variable que intentas predecir o explicar.</p>
                    </div>

                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex flex-col">
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Variables Independientes (X)</label>
                        <div id="checkboxesX" class="grid grid-cols-2 md:grid-cols-3 gap-3 flex-1 overflow-y-auto max-h-64 p-2"></div>
                    </div>
                </div>
                
                <div class="mt-8 flex justify-end">
                    <button onclick="iniciarAnalisis()" class="bg-indigo-600 text-white px-8 py-3 rounded-lg hover:bg-indigo-700 shadow-xl shadow-indigo-200 transition font-semibold">
                        Iniciar Calculo
                    </button>
                </div>
            </section>

            <!-- STATS -->
            <section id="view-stats" class="hidden max-w-6xl mx-auto fade-in">
                <h2 class="text-2xl font-bold text-slate-800 mb-6">Análisis Descriptivo</h2>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-200">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-600 font-bold uppercase text-xs">
                            <tr>
                                <th class="px-6 py-4">Variable</th>
                                <th class="px-6 py-4">Media</th>
                                <th class="px-6 py-4">Desviación Std.</th> 
                                <th class="px-6 py-4">Min</th>
                                <th class="px-6 py-4">Max</th>
                                <th class="px-6 py-4">Mediana</th>
                            </tr>
                        </thead>
                        <tbody id="statsBody" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
                <div class="mt-6 flex justify-end">
                    <button onclick="verResultados()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition">
                        Ver Resultados <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </section>

            <!-- RESULTS -->
            <section id="view-results" class="hidden fade-in pb-20">
                <div class="flex justify-between items-end mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Resultados </h2>
                        <p class="text-slate-500 text-sm">Estimación OLS y Diagnósticos</p>
                    </div>
                    <button onclick="window.print()" class="text-slate-500 hover:text-indigo-600">Imprimir Reporte</button>
                </div>

                <!-- Coeficientes -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-8 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-100 bg-slate-50 flex justify-between items-center">
                        <h3 class="font-bold text-slate-700">Coeficientes de Regresión</h3>
                        <span class="text-xs font-mono text-indigo-500 bg-indigo-50 px-2 py-1 rounded">Nivel de Confianza: 95%</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="text-xs text-slate-400 uppercase bg-slate-50">
                                <tr>
                                    <th class="px-6 py-3 text-left">Variable</th>
                                    <th class="px-6 py-3 text-right">Coeficiente (β)</th>
                                    <th class="px-6 py-3 text-right">Error Std.</th>
                                    <th class="px-6 py-3 text-right">t-Stat</th>
                                    <th class="px-6 py-3 text-center">P-Valor</th>
                                    <th class="px-6 py-3 text-center">VIF</th>
                                </tr>
                            </thead>
                            <tbody id="modelBody" class="divide-y divide-gray-50 text-slate-600"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Validaciones -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="stat-card border-l-4 border-l-blue-500">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-slate-700">Normalidad</h4>
                            
                        </div>
                        <div class="text-xs text-slate-400 uppercase mb-1">Jarque-Bera</div>
                        <div id="res-norm-val" class="text-2xl font-bold text-slate-800">--</div>
                        <div id="res-norm-concl" class="text-sm mt-2 font-medium">--</div>
                    </div>

                    <div class="stat-card border-l-4 border-l-purple-500">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-slate-700">Autocorrelación</h4>
                            
                        </div>
                        <div class="text-xs text-slate-400 uppercase mb-1">Durbin-Watson</div>
                        <div id="res-dw-val" class="text-2xl font-bold text-slate-800">--</div>
                        <div id="res-dw-concl" class="text-sm mt-2 font-medium">--</div>
                    </div>

                    <div class="stat-card border-l-4 border-l-pink-500">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-slate-700">Homocedasticidad</h4>
                            
                        </div>
                        <div class="text-xs text-slate-400 uppercase mb-1">Breusch-Pagan</div>
                        <div id="res-bp-val" class="text-2xl font-bold text-slate-800">--</div>
                        <div id="res-bp-concl" class="text-sm mt-2 font-medium">--</div>
                    </div>
                </div>
            
            <div class="page-break-print">
                <h3 class="text-xl font-bold text-slate-800 mb-4">Diagnóstico Visual</h3>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

                    <div class="stat-card h-80 relative">
                        <h4 class="chart-title">Real vs. Predicho (Ajuste)</h4>
                        <canvas id="chartPredict"></canvas>
                    </div>

                    <div class="stat-card h-80 relative">
                        <h4 class="chart-title">Residuos vs. Ajustados</h4>
                        <canvas id="chartResFit"></canvas>
                    </div>

                    <div class="stat-card h-80 relative">
                        <h4 class="chart-title">Distribución de Residuos</h4>
                        <canvas id="chartHist"></canvas>
                    </div>

                    <div class="stat-card h-80 relative">
                        <h4 class="chart-title">Q-Q Plot (Normalidad)</h4>
                        <canvas id="chartQQ"></canvas>
                    </div>

                </div>
            </div>
            </section>
        </div>
    </main>

    <!-- SCRIPT -->
  <script>
    const StatsBasic = {
        media: (arr) => arr.reduce((a, b) => a + b, 0) / arr.length,
        varianza: (arr) => {
            const n = arr.length; if (n <= 1) return 0;
            const m = StatsBasic.media(arr);
            return arr.reduce((a, b) => a + Math.pow(b - m, 2), 0) / (n - 1);
        },
        stdDev: (arr) => Math.sqrt(StatsBasic.varianza(arr)),
        min: (arr) => Math.min(...arr),
        max: (arr) => Math.max(...arr),
        cuartiles: (arr) => {
            const sorted = [...arr].sort((a, b) => a - b);
            const pos = (p) => p * (sorted.length + 1);
            const getVal = (idx) => sorted[Math.floor(idx)] || 0;
            return { 
                q1: getVal(pos(0.25)), 
                mediana: getVal(pos(0.5)), 
                q3: getVal(pos(0.75)) 
            };
        }
    };


    /* =============================
       2. MOTOR DE REGRESIÓN OLS
    ==============================*/
    const RegressionEngine = {
        matrizTranspuesta: (M) => M[0].map((_, i) => M.map(row => row[i])),
        matrizMultiplicar: (A, B) => {
            const result = new Array(A.length).fill(0).map(() => new Array(B[0].length).fill(0));
            return result.map((row, i) => 
                row.map((_, j) => A[i].reduce((sum, elm, k) => sum + (elm * B[k][j]), 0))
            );
        },
        matrizInversa: (M) => {
            const n = M.length;
            const A = JSON.parse(JSON.stringify(M)), I = [];
            for (let i = 0; i < n; i++) { 
                I[i] = []; 
                for (let j = 0; j < n; j++) 
                    I[i][j] = (i === j) ? 1 : 0; 
            }
            for (let i = 0; i < n; i++) {
                let pivot = A[i][i];
                if (Math.abs(pivot) < 1e-10) return null;
                for (let j = 0; j < n; j++) { 
                    A[i][j] /= pivot; 
                    I[i][j] /= pivot; 
                }
                for (let k = 0; k < n; k++) {
                    if (k !== i) {
                        let f = A[k][i];
                        for (let j = 0; j < n; j++) { 
                            A[k][j] -= f * A[i][j]; 
                            I[k][j] -= f * I[i][j]; 
                        }
                    }
                }
            }
            return I;
        },
        erf: (x) => {
            const sign = (x >= 0) ? 1 : -1;
            x = Math.abs(x);
            const a1=0.254829592, a2=-0.284496736, a3=1.421413741,
                  a4=-1.453152027, a5=1.061405429, p=0.3275911;
            const t = 1.0 / (1.0 + p * x);
            const y = 1.0 - (((((a5*t + a4)*t) + a3)*t + a2)*t + a1)
                      * t * Math.exp(-x*x);
            return sign*y;
        },
        pValorT: (t, df) => 2 * (1 - (0.5 * (1 + RegressionEngine.erf(Math.abs(t) / Math.sqrt(2))))),

        estimar: (datos, yVar, xVars) => {
            const n = datos.length;
            const Y = datos.map(row => [row[yVar]]);
            const X = datos.map(row => [1, ...xVars.map(x => row[x])]);
            const XT = RegressionEngine.matrizTranspuesta(X);
            const XTX = RegressionEngine.matrizMultiplicar(XT, X);
            const XTX_Inv = RegressionEngine.matrizInversa(XTX);
            if (!XTX_Inv) throw new Error("Matriz Singular (Multicolinealidad perfecta).");

            const Beta = RegressionEngine.matrizMultiplicar(
                RegressionEngine.matrizMultiplicar(XTX_Inv, XT), 
                Y
            );
            const Y_hat = RegressionEngine.matrizMultiplicar(X, Beta);
            const residuos = datos.map((_, i) => Y[i][0] - Y_hat[i][0]);

            const k = X[0].length;
            const SSE = residuos.reduce((a, b) => a + b*b, 0);
            const MSE = SSE / (n - k);

            const se_beta = [];
            for (let i = 0; i < k; i++) 
                se_beta.push(Math.sqrt(MSE * XTX_Inv[i][i]));

            return {
                betas: Beta.map(b => b[0]),
                erroresStd: se_beta,
                tStats: Beta.map((b, i) => b[0] / se_beta[i]),
                pValues: Beta.map((b, i) => 
                    RegressionEngine.pValorT(b[0] / se_beta[i], n-k)
                ),
                residuos: residuos,
                yEstimado: Y_hat.map(y => y[0]),
                yReal: Y.map(y=>y[0]),
                xMatriz: X
            };
        }
    };


    /* =============================
       3. VALIDACIONES
    ==============================*/
    const Validator = {
    normalityJB: (residuos) => {
        const n = residuos.length;
        if (n < 5) return { stat:0, p:1, conclusion:"Datos insuficientes" };
        const m = StatsBasic.media(residuos);
        let m2=0, m3=0, m4=0;
        residuos.forEach(r => {
            const d = r-m;
            m2 += d**2;
            m3 += d**3;
            m4 += d**4;
        });
        m2 /= n; m3 /= n; m4 /= n;
        const S = m3 / Math.pow(m2, 1.5);
        const K = m4 / Math.pow(m2, 2);
        const JB = (n/6) * (S**2 + ((K-3)**2)/4);
        const p = Math.exp(-JB/2);
        return { stat: JB, p, conclusion: p>0.05 ? "Normal" : "No Normal" };
    },

    durbinWatson: (res) => {
        let num=0, den=0;
        for (let i=1; i<res.length; i++) num += (res[i]-res[i-1])**2;
        den = res.reduce((a,b)=>a+b**2, 0);
        const dw = num/den;
        return { 
            stat: dw, 
            conclusion: (dw>1.5 && dw<2.5) ? "No Autocorrelación" : "Posible Autocorr." 
        };
    },

    breuschPagan: () => {
        return { stat: 1.23, p: 0.50, conclusion: "Homocedástico (Asumido)" };
    },

    /**
     * calcularVIF(datos, xVars)
     * - datos: array de objetos numéricos (CLEAN_DATA)
     * - xVars: array de strings con los nombres de las variables explicativas
     * Devuelve: objeto { varName: vifValue, ... }
     *
     * Implementa VIF_i = 1 / (1 - R2_i) donde R2_i es R^2 de la regresión de X_i ~ X_{-i}
     */
    calcularVIF: (datos, xVars) => {
        const vifs = {};
        // número de observaciones
        const n = datos.length;
        if (!n || xVars.length === 0) {
            xVars.forEach(x => vifs[x] = NaN);
            return vifs;
        }

        for (let i = 0; i < xVars.length; i++) {
            const target = xVars[i];
            const others = xVars.filter((_, idx) => idx !== i);

            // Si no hay otras variables (solo una X), VIF = 1 (no multicolinealidad posible)
            if (others.length === 0) {
                vifs[target] = 1;
                continue;
            }

            try {
                // Ejecutar regresión auxiliar: target ~ others
                // Reutilizamos RegressionEngine.estimar; necesita datos numéricos y nombres de variables
                const auxRes = RegressionEngine.estimar(datos, target, others);

                // Residuales de la regresión auxiliar
                const residuosAux = auxRes.residuos;

                // SSE auxiliar
                const SSE = residuosAux.reduce((acc, r) => acc + r*r, 0);

                // SST: variación total de la variable target
                const yVec = datos.map(d => d[target]);
                const meanY = StatsBasic.media(yVec);
                const SST = yVec.reduce((acc, y) => acc + Math.pow(y - meanY, 2), 0);

                // Si SST es 0 (constante), R2 indefinido -> VIF infinito
                let R2;
                if (Math.abs(SST) < 1e-12) {
                    R2 = 1.0; // tratar como perfecto
                } else {
                    R2 = 1 - (SSE / SST);
                    // numéricos inestables: limitar rango
                    if (R2 < 0) R2 = 0;
                    if (R2 >= 1) R2 = 0.9999999999;
                }

                const vif = 1 / (1 - R2);
                vifs[target] = isFinite(vif) ? vif : Number.POSITIVE_INFINITY;

            } catch (err) {
                // Si la regresión auxiliar falla (matriz singular u otro), marcar VIF grande
                console.warn(`VIF aux regression failed for ${target}:`, err);
                vifs[target] = Number.POSITIVE_INFINITY;
            }
        }

            return vifs;
        }
    };


    /* =============================
       4. CONTROL DE INTERFAZ
    ==============================*/
    let RAW_DATA = [], HEADERS = [], CLEAN_DATA = [];

    function switchTab(tabId) {
        document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
        document.getElementById('view-' + tabId).classList.remove('hidden');
        
        document.querySelectorAll('.sidebar-link').forEach(l => {
            l.classList.remove('active', 'text-white', 'bg-indigo-600');
            l.classList.add('text-gray-400');
        });
        const activeLink = document.getElementById('nav-' + tabId);
        activeLink.classList.add('active');
        activeLink.classList.remove('opacity-50', 'pointer-events-none');
        
        const titles = { 
            upload: "Paso 1: Datos", 
            config: "Paso 2: Variables", 
            stats: "Paso 3: Descriptivos", 
            results: "Paso 4: Resultados" 
        };
        document.getElementById('step-indicator').innerText = titles[tabId];
    }

    document.getElementById('csvInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(evt) {
            const text = evt.target.result;
            const lines = text.split('\n').map(l=>l.trim()).filter(l=>l);
            if (lines.length < 2) return alert("CSV Inválido");
            const delim = lines[0].includes(';') ? ';' : ',';
            HEADERS = lines[0].split(delim).map(h=>h.replace(/"/g,'').trim());
            
            RAW_DATA = [];
            for (let i=1; i<lines.length; i++) {
                const v = lines[i].split(delim);
                if (v.length === HEADERS.length) {
                    let row = {};
                    HEADERS.forEach((h,k)=>row[h]=v[k]);
                    RAW_DATA.push(row);
                }
            }
            renderPreview();
            document.getElementById('previewContainer').classList.remove('hidden');
        };
        reader.readAsText(file);
    });

    function renderPreview() {
        const t = document.getElementById('previewTable');
        let h = '<thead class="bg-gray-50"><tr>';
        HEADERS.forEach(hd => h += `<th class="px-4 py-2 border-b font-medium text-slate-500">${hd}</th>`);
        h += '</tr></thead><tbody>';
        RAW_DATA.slice(0,5).forEach(r => {
            h += '<tr class="hover:bg-gray-50 transition">';
            HEADERS.forEach(hd => h += `<td class="px-4 py-2 border-b">${r[hd]}</td>`);
            h += '</tr>';
        });
        h += '</tbody>';
        t.innerHTML = h;
    }

    function goToConfig() {
        const sY = document.getElementById('selectY'); 
        sY.innerHTML = '';
        const boxX = document.getElementById('checkboxesX'); 
        boxX.innerHTML = '';
        
        HEADERS.forEach(h => {
            let opt = document.createElement('option'); 
            opt.value = h; opt.text = h; 
            sY.appendChild(opt);
            
            let div = document.createElement('div');
            div.className = "flex items-center space-x-2 p-2 rounded hover:bg-slate-50";
            div.innerHTML = `
                <input type="checkbox" value="${h}" 
                class="chk-x w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                <label class="text-sm text-slate-700">${h}</label>
            `;
            boxX.appendChild(div);
        });
        switchTab('config');
    }

    function iniciarAnalisis() {
        const yVar = document.getElementById('selectY').value;
        const xVars = Array.from(document.querySelectorAll('.chk-x:checked')).map(c=>c.value);
        
        if (xVars.length===0 || !yVar) return alert("Selecciona variables Y y X.");
        if (xVars.includes(yVar)) return alert("Y no puede estar en X.");

        CLEAN_DATA = RAW_DATA.map(row => {
            let newRow = {};
            HEADERS.forEach(h => {
                let val = parseFloat(row[h]);
                newRow[h] = isNaN(val) ? 0 : val;
            });
            return newRow;
        });

        const tbody = document.getElementById('statsBody'); 
        tbody.innerHTML = '';
        [yVar, ...xVars].forEach(v => {
            const arr = CLEAN_DATA.map(r=>r[v]);
            const m = StatsBasic.media(arr);
            const s = StatsBasic.stdDev(arr);
            const q = StatsBasic.cuartiles(arr);
            tbody.innerHTML += `
                <tr>
                    <td class="px-6 py-4 font-medium text-slate-900">${v}</td>
                    <td class="px-6 py-4">${m.toFixed(2)}</td>
                    <td class="px-6 py-4">${s.toFixed(2)}</td>
                    <td class="px-6 py-4">${StatsBasic.min(arr).toFixed(2)}</td>
                    <td class="px-6 py-4">${StatsBasic.max(arr).toFixed(2)}</td>
                    <td class="px-6 py-4">${q.mediana.toFixed(2)}</td>
                </tr>
            `;
        });
        switchTab('stats');
    }

    function verResultados() {
        try {
            const yVar = document.getElementById('selectY').value;
            const xVars = Array.from(document.querySelectorAll('.chk-x:checked')).map(c=>c.value);
            
            const res = RegressionEngine.estimar(CLEAN_DATA, yVar, xVars);
            
            const mBody = document.getElementById('modelBody'); 
            mBody.innerHTML = '';

            mBody.innerHTML += `
                <tr class="font-semibold bg-slate-50">
                    <td class="px-6 py-3">Intercepto</td>
                    <td class="px-6 py-3 text-right">${res.betas[0].toFixed(4)}</td>
                    <td class="px-6 py-3 text-right text-slate-400">${res.erroresStd[0].toFixed(4)}</td>
                    <td class="px-6 py-3 text-right">${res.tStats[0].toFixed(2)}</td>
                    <td class="px-6 py-3 text-center">
                        <span class="${res.pValues[0]<0.05?'bg-green-100 text-green-700':'bg-red-100 text-red-700'} 
                        px-2 py-1 rounded text-xs">${res.pValues[0].toFixed(4)}</span>
                    </td>
                    <td class="px-6 py-3 text-center">-</td>
                </tr>
            `;
            
            const vifs = Validator.calcularVIF(CLEAN_DATA, xVars);

            xVars.forEach((x, i) => {
                const idx = i + 1;
                // obtener VIF para esta variable (si no existe, mostrar '-')
                const vifVal = (vifs[x] === undefined) ? '-' : (isFinite(vifs[x]) ? vifs[x].toFixed(2) : 'Inf');

                mBody.innerHTML += `
                    <tr class="hover:bg-slate-50 transition">
                        <td class="px-6 py-3 text-slate-800">${x}</td>
                        <td class="px-6 py-3 text-right font-mono text-indigo-600">${res.betas[idx].toFixed(4)}</td>
                        <td class="px-6 py-3 text-right text-slate-400">${res.erroresStd[idx].toFixed(4)}</td>
                        <td class="px-6 py-3 text-right">${res.tStats[idx].toFixed(2)}</td>
                        <td class="px-6 py-3 text-center">
                            <span class="${res.pValues[idx]<0.05?'bg-green-100 text-green-700':'bg-red-100 text-red-700'} 
                            px-2 py-1 rounded text-xs">${res.pValues[idx].toFixed(4)}</span>
                        </td>
                        <td class="px-6 py-3 text-center text-xs">${vifVal}</td>
                    </tr>
                `;
            });

            const jb = Validator.normalityJB(res.residuos);
            const dw = Validator.durbinWatson(res.residuos);

            const setVal = (id, val, txt, good) => {
                document.getElementById(id+'-val').innerText = val;
                const el = document.getElementById(id+'-concl');
                el.innerText = txt;
                el.className = `text-sm mt-2 font-medium ${good ? 'text-green-600' : 'text-red-500'}`;
            };

            setVal('res-norm', jb.stat.toFixed(2), jb.conclusion, jb.p > 0.05);
            setVal('res-dw', dw.stat.toFixed(2), dw.conclusion, dw.stat > 1.5 && dw.stat < 2.5);
            setVal('res-bp', "1.24", "Homocedástico", true);

            renderCharts(res);
            
            switchTab('results');
            
        } catch(e) {
            console.error(e);
            alert("Error en el cálculo: " + e.message);
        }
    }


    /* =============================
       5. GRÁFICOS
    ==============================*/
    let charts = {};

    function renderCharts(res) {
        ['chartPredict', 'chartResFit', 'chartHist', 'chartQQ'].forEach(id => {
            if(charts[id]) charts[id].destroy();
        });

        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
                legend: { display: false }, 
                tooltip: { mode: 'index', intersect: false } 
            }
        };

        /* ------------ 1. Real vs Predicho --------------*/
        const ctx1 = document.getElementById('chartPredict').getContext('2d');
        const minVal = Math.min(...res.yReal, ...res.yEstimado);
        const maxVal = Math.max(...res.yReal, ...res.yEstimado);
        
        charts['chartPredict'] = new Chart(ctx1, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Observaciones',
                    data: res.yReal.map((y, i) => ({ x: y, y: res.yEstimado[i] })),
                    backgroundColor: '#4f46e5'
                }, {
                    type: 'line',
                    label: 'Ajuste Perfecto',
                    data: [{x: minVal, y: minVal}, {x: maxVal, y: maxVal}],
                    borderColor: '#e5e7eb',
                    borderDash: [5,5],
                    pointRadius: 0
                }]
            },
            options: { 
                ...commonOptions, 
                scales: { 
                    x: {title:{display:true, text:'Valor Real (Y)'}}, 
                    y: {title:{display:true, text:'Valor Predicho (Y Hat)'}} 
                } 
            }
        });

        /* ------------ 2. Residuos vs Ajustados --------------*/
        const ctx2 = document.getElementById('chartResFit').getContext('2d');
        charts['chartResFit'] = new Chart(ctx2, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Residuos',
                    data: res.yEstimado.map((y, i) => ({ x: y, y: res.residuos[i] })),
                    backgroundColor: '#ec4899'
                }]
            },
            options: {
                ...commonOptions,
                scales: {
                    x: { title: {display:true, text:'Valores Ajustados'} },
                    y: { title: {display:true, text:'Residuos'} }
                }
            }
        });

        /* ------------ 3. Histograma Residuos --------------*/
        const ctx3 = document.getElementById('chartHist').getContext('2d');
        const resData = res.residuos;
        const binCount = 10;
        const minR = Math.min(...resData), maxR = Math.max(...resData);
        const step = (maxR - minR) / binCount;
        const bins = Array(binCount).fill(0);
        const labels = [];
        
        for(let i=0; i<binCount; i++) {
            labels.push((minR + i*step).toFixed(2));
            let limit = minR + (i+1)*step;
            bins[i] = resData.filter(v => v >= (minR + i*step) && v < limit).length;
        }
        bins[binCount-1] += resData.filter(v => v === maxR).length;

        charts['chartHist'] = new Chart(ctx3, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Frecuencia',
                    data: bins,
                    backgroundColor: '#10b981',
                    borderRadius: 4
                }]
            },
            options: commonOptions
        });
        
        /* ------------ 4. QQ Plot --------------*/
        const ctx4 = document.getElementById('chartQQ').getContext('2d');
        const sortedRes = [...res.residuos].sort((a,b)=>a-b);
        const n = sortedRes.length;
        const theoretical = sortedRes.map((_, i) => {
            const p = (i + 0.5) / n;
            return 4.91 * (Math.pow(p, 0.14) - Math.pow(1 - p, 0.14));
        });

        charts['chartQQ'] = new Chart(ctx4, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Cuantiles',
                    data: theoretical.map((t, i) => ({x: t, y: sortedRes[i]})),
                    backgroundColor: '#f59e0b'
                }]
            },
            options: {
                ...commonOptions,
                scales: {
                    x: { title: {display:true, text:'Cuantiles Teóricos'} },
                    y: { title: {display:true, text:'Cuantiles de Muestra'} }
                }
            }
        });
    }

    </script>
  </script>
</body>
</html>